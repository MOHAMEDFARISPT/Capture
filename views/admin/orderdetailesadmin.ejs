<!DOCTYPE html>
<html lang="en">
   
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    


    <!-- Add your CSS stylesheets and other head elements here -->
</head>

<style>
    body {
      letter-spacing: 0.8px;
      background: linear-gradient(0deg , #fff , 50% , #74a0ff);
      background-repeat: no-repeat;    
  }
  
  .container-fluid {
      margin-top: 80px !important;
      margin-bottom: 80px !important;
  }
  
  p {
      font-size: 14px;
      margin-bottom: 7px;
  }
  
  .cursor-pointer {
      cursor: pointer;
  }
  
  a{
      text-decoration: none !important;
      color: #651FFF !important;
  }
  
  .bold{
      font-weight: 600;
  }
  
  .small{
      font-size: 12px !important;
      letter-spacing: 0.5px !important;
  }
  
  .Today{
      color: rgb(83, 83, 83);
  }
  
  .btn-outline-primary{
      background-color: #fff !important;
      color:#4bb8a9 !important;
      border:1.3px solid #4bb8a9;
      font-size: 12px;
      border-radius: 0.4em !important;
  }
  
  .btn-outline-primary:hover{
      background-color:#4bb8a9  !important;
      color:#fff !important;
      border:1.3px solid #4bb8a9;
  }
  
  .btn-outline-primary:focus,
  .btn-outline-primary:active {
      outline: none !important;
      box-shadow: none !important;
      border-color: #42A5F5 !important;
  }
   
  #progressbar {
      margin-bottom: 30px;
      overflow: hidden;
      color: #455A64;
      padding-left: 0px;
      margin-top: 30px
  }
  
  #progressbar li {
      list-style-type: none;
      font-size: 13px;
      width: 33.33%;
      float: left;
      position: relative;
      font-weight: 400;
      color: #455A64 !important;
      
  }
  
  #progressbar #step1:before {
      content: "1";
      color: #fff;
      width: 29px;
      margin-left: 15px !important;
      padding-left: 11px !important;
  }
  
  
  #progressbar #step2:before {
      content: "2";
      color: #fff;
      width: 29px;
  
  }
  
  #progressbar #step3:before {
      content: "3";
      color: #fff;
      width: 29px;
      margin-right: 15px !important;
      padding-right: 11px !important;
  }
  
  #progressbar li:before {
      line-height: 29px;
      display: block;
      font-size: 12px;
      background: #455A64 ;
      border-radius: 50%;
      margin: auto;
  }
  
   #progressbar li:after {
      content: '';
      width: 121%;
      height: 2px;
      background: #455A64;
      position: absolute;
      left: 0%;
      right: 0%;
      top: 15px;
      z-index: -1;
  } 
  
  #progressbar li:nth-child(2):after {
      left: 50%;
  }
  
  #progressbar li:nth-child(1):after {
      left: 25%;
      width: 121%;
  }
  #progressbar li:nth-child(3):after {
      left: 25% !important;
      width: 50% !important;
  }
  
  #progressbar li.active:before,
  #progressbar li.active:after {
      background: #4bb8a9; 
  }
  
  .card {
      background-color: #fff ;
      box-shadow: 2px 4px 15px 0px rgb(0, 108, 170);
      z-index: 0;
  }
  
  small{
      font-size: 12px !important;
  }
  
  .a {
      justify-content: space-between !important;
  }
  
  .border-line {
      border-right: 1px solid rgb(226, 206, 226)
  }
  
  .card-footer img{
      opacity: 0.3;
  }
  
  .card-footer h5{
      font-size: 1.1em;
      color: #8C9EFF;
      cursor: pointer;
  }
  </style>
  <body>
    <div class="container-fluid my-5 d-sm-flex justify-content-center">
      <div class="card px-2">
          <div class="card-header bg-white">
            <div class="row justify-content-between">
              
           
                <div class="d-flex justify-content-between pt-2">
                    <p class="fw-bold mb-0">Delivery Address</p>
                </div>
                
                <div class="d-flex justify-content-between pt-2">
                    <p class="text-muted mb-0">Name: <%= order.address.name %></p>
                </div>


                
                <div class="d-flex justify-content-between">
                    <p class="text-muted mb-0">Mobile: <%= order.address.mobile %></p>
                </div>
                
                <div class="d-flex justify-content-between mb-5">
                    <p class="text-muted mb-0">
                        Locality: <%= order.address.locality %>, <%= order.address.city %>,
                        <%= order.address.pincode %>, <%= order.address.state %>
                    </p>
                </div>
                
                
                <div class="d-flex justify-content-between mb-5">
                    <% if (order && order.userId) { %>
                    <p class="text-muted mb-0">Email: <%= order.userId.email %></p>
                    <% } else { %>
                        <p class="text-muted mb-0">Email: </p>
                    <% } %>
                </div>
                
             
  
  
  
  
                  <div class="flex-col my-auto">
                      <h6 class="ml-auto mr-3">
                        <h3>Orders On OrderID:<%= order.orderId%></h3>
                      </h6>
                  </div>
            </div>
          </div>
          <div class="card-body">
            <div class="card-body">
                <% order.products.forEach(item => {%>

                    <div class="media flex-column flex-sm-row">
                        <div class="media-body">
                            <h5 class="bold">Product:<%=item.productId.productname %></h5>
                            <label for="orderStatus">Select Order Status:</label>
                            <%= item.cancelstatus %>
                            <%item.reason %>
                            <select id="select<%=item.productId._id %>" name="orderStatus" onchange="updateOrderStatus('<%=item.productId._id %>','<%= order._id %>')">
                                <% switch (item.cancelstatus) {
                                    case 'pending': %>
                                    <option value="Pending" selected>Pending</option>
                                    <option value="Processing">Processing</option>
                                    <option value="Shipped">Shipped</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Canceled">Canceled</option>
                                    <option value="Failed" disabled>Failed</option>
                                    <% break;
                                    case 'processing': %>
                                    <option value="Pending" disabled>Pending</option>
                                    <option value="Processing" selected>Processing</option>
                                    <option value="Shipped">Shipped</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Canceled">Canceled</option>
                                    <option value="Failed" disabled>Failed</option>
                                    <% break;
                                    case 'shipped': %>
                                    <option value="Pending" disabled>Pending</option>
                                    <option value="Processing" disabled>Processing</option>
                                    <option value="Shipped" selected>Shipped</option>
                                    <option value="Delivered">Delivered</option>
                                    <option value="Canceled">Canceled</option>
                                    <option value="Failed" disabled>Failed</option>
                                    <% break;
                                    case 'delivered': %>
                                    <option value="Pending" disabled>Pending</option>
                                    <option value="Processing" disabled>Processing</option>
                                    <option value="Shipped" disabled>Shipped</option>
                                    <option value="Delivered" selected>Delivered</option>
                                    <option value="Canceled" disabled>Canceled</option>
                                    <option value="Failed" disabled>Failed</option>
                                    <% break;
                                    case 'canceled': %>
        <option value="Pending" disabled>Pending</option>
        <option value="Processing" disabled>Processing</option>
        <option value="Shipped" disabled>Shipped</option>
        <option value="Delivered" disabled>Delivered</option>
        <option value="Canceled" selected>Canceled</option>
        <option value="Failed" disabled>Failed</option>
        </select>

        <!-- Render the reason dropdown only when 'Canceled' is selected -->
        <% if (item.cancelstatus === 'canceled') { %>
            <select id="reasonDropdown<%= item.productId._id %>" name="cancelReason">
                <option value="" selected disabled>Select Reason</option>
                <option value="Not Needed Now">Out Of Stock</option>
                <option value="Changed my mind">Not Eligible For Free Delivery</option>
                <option value="Delivery Date Too Late">Delivery Date Too Late</option>
                <option value="Other">Other</option>
            </select>
        <% } %>
        
                                    <% break;
                                    case 'returned': %>    
                                    <option value="Pending" disabled>Pending</option>
                                    <option value="Processing" disabled>Processing</option>
                                    <option value="Shipped" disabled>Shipped</option>
                                    <option value="Delivered" disabled>Delivered</option>
                                    <option value="Canceled" disabled>Canceled</option>
                                    <option value="Returned" selected>Returned</option>
                                    <option value="Failed" disabled>Failed</option>
                                    <% break;
                                    default: %>
                                    <option value="Pending" disabled>Pending</option>
                                    <option value="Processing" disabled>Processing</option>
                                    <option value="Shipped" disabled>Shipped</option>
                                    <option value="Delivered" disabled>Delivered</option>
                                    <option value="Canceled" disabled>Canceled</option>
                                    <option value="Failed" >Failed</option>
                                <% } %>
                            </select>
                            <h4 class="mt-3 mb-4 bold"><span class="mt-5"></span>Quantity:<%=item.quantity%><span class="small text-muted"></span></h4>
                            <h4 class="mt-3 mb-4 bold"><span class="mt-5"></span>Price:₹<%= item.productId.price%><span class="small text-muted"></span></h4>
                        </div>
                        <img class="align-self-center img-fluid" src="<%=item.productId.productImage[0]%>" width="180" height="180">
                    </div>
                <%})%>
                <div><h4>Total Amount:₹<%=order.totalAmount%></h4></div>
            </div>
            
         
          
          
          <div class="row px-3">
              <div class="col">
                  <ul id="progressbar" >
                      <li class="step0 active " id="step1">PLACED</li>
                      <li class="step0 active text-center" id="step2">SHIPPED</li>
                      <li class="step0  text-muted text-right" id="step3">DELIVERED</li>
                  </ul>
              </div>
          </div>
           <div class="card-footer  bg-white px-sm-3 pt-sm-4 px-0">
            
                <div class="row text-center">
                    <div class="col my-auto border-line"><a href="/orderlist"><h5>Orders</h5></a></div>
                    <div class="col my-auto border-line"><a href="/"><h5>Dashboard</h5></a></div>
                    <!-- <div class="col my-auto border-line"><a href=""><h5>Home</h5></a></div> -->
                </div>
            
            
          </div>
      </div>
  </div>
    
      <!-- Add your JavaScript scripts and other body elements here -->
    </body>

    <script>
        function updateOrderStatus(productId, orderId) {
           
            // Get the selected order status
            const selectedOrderStatus = document.getElementById('select' + productId).value;
    
            // If the selected order status is 'Canceled', get the cancellation reason
            let cancelReason = null;
            if (selectedOrderStatus === 'Canceled') {
                const reasonDropdown = document.getElementById('reasonDropdown' + productId);
                cancelReason = reasonDropdown ? reasonDropdown.value : null;
            }

            // Log the values for debugging
            console.log('productId:', productId);
            console.log('orderId:', orderId);
            console.log('selectedOrderStatus:', selectedOrderStatus);
            console.log('cancelReason:', cancelReason);
    
            // Use Fetch to send data to your server
            fetch('/update-order-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ orderId, productId, selectedOrderStatus, cancelReason }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error updating order status');
                }
                return response.json();
            })
            .then(data => {
                window.location.reload()
                console.log('Response from server:', data);
            })
            .catch(error => {
                console.error('Error updating order status:', error.message);
            });
        }
    </script>
    
    
  </html>
  